## 研究总结

经过全面研究 `src-tauri` 目录中的所有编码相关代码，发现了以下主要问题：

### 发现的问题

1. **歌词文件强制UTF-8** (lyric_enhancer.rs 第159-168行、196-207行)
   - 强制使用UTF-8解码，GBK编码歌词会出现乱码

2. **缺少亚洲语言编码支持** (encoding.rs)
   - 缺少Big5（繁体中文）、Shift-JIS（日文）、EUC-KR（韩文）

3. **UTF-16代理对验证不完整** (encoding.rs 第219-222行)
   - 代理对验证被简化，可能导致UTF-16解析错误

4. **文件路径编码问题** (music_scanner.rs)
   - 使用 `to_str()` 处理文件名，非UTF-8字符会丢失

5. **ID3v2 Latin1编码GBK检测不够积极** (mp3.rs)
   - 中文MP3标签实际使用GBK编码，但检测不够积极

---

## 批量处理器已完成的修改方案

### 任务1: 修复歌词文件编码检测 ✅
**文件**: `lyric_enhancer.rs`
- 引入 `auto_decode_text` 函数
- 替换两处强制UTF-8解码为智能编码检测
- 支持UTF-8、GBK、GB18030、Big5、Shift-JIS、EUC-KR等编码

### 任务2: 增强encoding.rs编码支持 ✅
**文件**: `encoding.rs`
- 添加Big5、ShiftJis、EucKr编码类型
- 完善UTF-16代理对验证（高代理对0xD800-0xDBFF，低代理对0xDC00-0xDFFF）
- 添加编码置信度评分机制（High/Medium/Low）
- 为每种编码实现专门的检测函数和置信度计算

### 任务3: 修复文件路径编码处理 ✅
**文件**: `music_scanner.rs`
- 将 `to_str()` 替换为 `to_string_lossy()`
- 修复3处路径编码问题（第362行、400行、414-417行）

### 任务4: 增强ID3v2编码处理 ✅
**文件**: `mp3.rs`
- 在Latin1编码分支添加积极GBK检测
- 检测到GBK特征时优先使用GBK解码
- 改进UTF-16奇数长度数据处理，添加日志记录

---

## 修改后的文件清单

| 文件 | 修改内容 |
|------|---------|
| `lyric_enhancer.rs` | 使用auto_decode_text替代强制UTF-8 |
| `encoding.rs` | 添加Big5/Shift-JIS/EUC-KR，完善代理对验证，添加置信度评分 |
| `music_scanner.rs` | 修复文件路径编码处理 |
| `mp3.rs` | 增强Latin1编码GBK检测，改进UTF-16处理 |

---

## 确认后执行

请确认此计划后，我将：
1. 应用所有批量处理器生成的修改
2. 运行测试验证编码修复
3. 确保所有修改编译通过