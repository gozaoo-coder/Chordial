# Chordial é¡¹ç›®ä»£ç ä¼˜åŒ–è®¡åˆ’

## åˆ†ææ€»ç»“

**é¡¹ç›®æ¦‚å†µï¼š**
- **ç±»å‹**ï¼šTauri æ¡Œé¢éŸ³ä¹æ’­æ”¾å™¨ï¼ˆRust åç«¯ + Vue å‰ç«¯ï¼‰
- **è§„æ¨¡**ï¼šRust ä»£ç çº¦ 6000+ è¡Œï¼Œå‰ç«¯ä»£ç çº¦ 8000+ è¡Œ
- **æµ‹è¯•**ï¼š85+ ä¸ª Rust å•å…ƒæµ‹è¯•

**å‘ç°çš„é—®é¢˜åˆ†ç±»ï¼š**

| ä¸¥é‡ç¨‹åº¦ | é—®é¢˜æ•°é‡ | ä¸»è¦ç±»å‹ |
|---------|---------|---------|
| **P0 - é˜»å¡æ€§** | 8 | unwrap æ»¥ç”¨ã€ä¸Šå¸å‡½æ•° |
| **P1 - æ˜æ˜¾åå‘³é“** | 15 | é‡å¤ä»£ç ã€é­”æ³•æ•°å­—ã€æ·±å±‚åµŒå¥— |
| **P2 - é£æ ¼é—®é¢˜** | 10 | æœªä½¿ç”¨å˜é‡ã€æ³¨é‡Šç¼ºå¤± |

---

## ğŸ”´ P0 çº§ä¼˜åŒ–ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

### 1. ä¿®å¤ unwrap/expect æ»¥ç”¨ï¼ˆ8å¤„ï¼‰

**æ¶‰åŠæ–‡ä»¶ï¼š**
- state.rs - `lock_state_unwrap` å®
- player.rs - Mutex é”è·å–
- mixer.rs - BPM ç›¸å…³æ–¹æ³•
- analyzer.rs - ç¼“å­˜é”

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
```rust
// æ›¿æ¢å‰
let guard = self.current_track.lock().unwrap();

// æ›¿æ¢å
let guard = self.current_track.lock()
    .map_err(|e| anyhow::anyhow!("Lock poisoned: {}", e))?;
```

### 2. æ‹†åˆ† `audio_thread_main` ä¸Šå¸å‡½æ•°ï¼ˆ170è¡Œï¼‰

**æ–‡ä»¶ï¼š** player.rs L194-L364

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
- æå– `process_player_commands()` - å¤„ç†æ’­æ”¾å™¨å‘½ä»¤
- æå– `decode_and_buffer_audio()` - éŸ³é¢‘è§£ç å’Œç¼“å†²
- æå– `handle_crossfade_logic()` - äº¤å‰æ·¡åŒ–é€»è¾‘
- æå– `send_audio_to_output()` - éŸ³é¢‘è¾“å‡º

### 3. æ‹†åˆ† `music_scanner.rs`ï¼ˆ909è¡Œï¼‰

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
- æ‹†åˆ†ä¸º `scanner/local.rs` - æœ¬åœ°æ–‡ä»¶å¤¹æ‰«æ
- æ‹†åˆ†ä¸º `scanner/webdav.rs` - WebDAV æ‰«æ
- æ‹†åˆ†ä¸º `scanner/track_builder.rs` - Track åˆ›å»ºé€»è¾‘

---

## ğŸŸ¡ P1 çº§ä¼˜åŒ–ï¼ˆå»ºè®®ä¿®å¤ï¼‰

### 4. æ¶ˆé™¤é‡å¤ä»£ç ï¼ˆ5å¤„ï¼‰

| ä½ç½® | é‡å¤å†…å®¹ | ä¼˜åŒ–æ–¹æ¡ˆ |
|------|---------|---------|
| lyric_parser/mod.rs | `parse_yrc` å’Œ `parse_qrc` é«˜åº¦ç›¸ä¼¼ | æå–é€šç”¨è§£æå‡½æ•° |
| music_scanner.rs | WebDAV/WebDev track åˆ›å»º | ç»Ÿä¸€ `create_track_from_metadata()` |
| library.rs | å›¾ç‰‡è·å–é€»è¾‘ | æå– `fetch_image()` é€šç”¨å‡½æ•° |
| player.rs | SharedAudioPlayer ä»£ç†æ–¹æ³• | ä½¿ç”¨å®æˆ–æ³›å‹ç®€åŒ– |

### 5. æå–é­”æ³•æ•°å­—ä¸ºå¸¸é‡ï¼ˆ12å¤„ï¼‰

**ä¸»è¦é­”æ³•æ•°å­—ï¼š**
```rust
const DEFAULT_CROSSFADE_DURATION: f32 = 10.0;
const BPM_DETECTION_WINDOW_SIZE: usize = (48000 * 5) / 1024;
const AUDIO_THREAD_SLEEP_MICROS: u64 = 100;
const FFT_SIZE: usize = 2048;
```

### 6. ç®€åŒ–æ·±å±‚åµŒå¥—ï¼ˆ4å¤„ï¼‰

**æœ€ä¸¥é‡ï¼š** music_scanner.rs L248-L317 - 5å±‚åµŒå¥—

### 7. æ‹†åˆ†è¿‡é•¿å‡½æ•°ï¼ˆ6ä¸ªï¼‰

| å‡½æ•° | å½“å‰è¡Œæ•° | ç›®æ ‡è¡Œæ•° |
|------|---------|---------|
| `audio_thread_main` | 170 | <50 |
| `batch_analyze` | 63 | <50 |
| `scan_local_folder` | 74 | <50 |
| `process_webdav_file` | 80 | <50 |
| `scan_web_dev` | 86 | <50 |
| `scan_all_sources` | 82 | <50 |

---

## ğŸŸ¢ P2 çº§ä¼˜åŒ–ï¼ˆå¯é€‰ä¿®å¤ï¼‰

### 8. æ¸…ç†æœªä½¿ç”¨çš„ä»£ç 
- library.rs - æœªä½¿ç”¨çš„ `_size` å‚æ•°
- analysis.rs - æœªä½¿ç”¨çš„ `AppHandle` å¯¼å…¥

### 9. å®Œå–„æ–‡æ¡£æ³¨é‡Š
- player.rs - BPM åŒæ­¥æ–¹æ³•ç¼ºå°‘å®ç°æ–‡æ¡£

### 10. å‰ç«¯ä»£ç ä¼˜åŒ–
- player.js - `play` å‡½æ•°è¿‡é•¿ï¼ˆ74è¡Œï¼‰
- AMLLyrics.vue - `initLyricPlayer` è¿‡é•¿ï¼ˆ70è¡Œï¼‰

---

## ğŸ“‹ ä¼˜åŒ–æ‰§è¡Œè®¡åˆ’

### é˜¶æ®µä¸€ï¼šP0 çº§ä¿®å¤ï¼ˆé¢„è®¡ 2-3 å¤©ï¼‰

| åºå· | ä»»åŠ¡ | æ¶‰åŠæ–‡ä»¶ | é¢„ä¼°å·¥æ—¶ |
|------|------|---------|---------|
| 1.1 | åˆ›å»ºé”™è¯¯å¤„ç†å·¥å…·æ¨¡å— | `error.rs` | 2h |
| 1.2 | ä¿®å¤ state.rs unwrap | `state.rs` | 1h |
| 1.3 | ä¿®å¤ player.rs unwrap | `player.rs` | 2h |
| 1.4 | ä¿®å¤ mixer.rs unwrap | `mixer.rs` | 2h |
| 1.5 | ä¿®å¤ analyzer.rs unwrap | `analyzer.rs` | 1h |
| 1.6 | æ‹†åˆ† audio_thread_main | `player.rs` | 4h |
| 1.7 | æ‹†åˆ† music_scanner.rs | `scanner/` | 6h |

### é˜¶æ®µäºŒï¼šP1 çº§ä¿®å¤ï¼ˆé¢„è®¡ 3-4 å¤©ï¼‰

| åºå· | ä»»åŠ¡ | æ¶‰åŠæ–‡ä»¶ | é¢„ä¼°å·¥æ—¶ |
|------|------|---------|---------|
| 2.1 | åˆå¹¶ YRC/QRC è§£æé€»è¾‘ | `lyric_parser/mod.rs` | 3h |
| 2.2 | ç»Ÿä¸€ Track åˆ›å»ºé€»è¾‘ | `scanner/` | 3h |
| 2.3 | æå–é­”æ³•æ•°å­—å¸¸é‡ | å¤šä¸ªæ–‡ä»¶ | 2h |
| 2.4 | ç®€åŒ–æ·±å±‚åµŒå¥— | `music_scanner.rs` | 3h |
| 2.5 | æ‹†åˆ†è¿‡é•¿å‡½æ•° | å¤šä¸ªæ–‡ä»¶ | 4h |

### é˜¶æ®µä¸‰ï¼šP2 çº§ä¿®å¤ï¼ˆé¢„è®¡ 1 å¤©ï¼‰

| åºå· | ä»»åŠ¡ | æ¶‰åŠæ–‡ä»¶ | é¢„ä¼°å·¥æ—¶ |
|------|------|---------|---------|
| 3.1 | æ¸…ç†æœªä½¿ç”¨ä»£ç  | å¤šä¸ªæ–‡ä»¶ | 2h |
| 3.2 | å®Œå–„æ–‡æ¡£æ³¨é‡Š | å¤šä¸ªæ–‡ä»¶ | 2h |
| 3.3 | å‰ç«¯ä»£ç ä¼˜åŒ– | `player.js`, `AMLLyrics.vue` | 4h |

---

## âš ï¸ é£é™©è¯„ä¼°

| é£é™©ç‚¹ | å½±å“ | ç¼“è§£æªæ–½ |
|--------|------|---------|
| unwrap æ”¹ error handling å¯èƒ½æ”¹å˜é”™è¯¯ä¼ æ’­è¡Œä¸º | ä¸­ | ç¡®ä¿æ‰€æœ‰è°ƒç”¨æ–¹æ­£ç¡®å¤„ç†æ–°çš„ error ç±»å‹ |
| å‡½æ•°æ‹†åˆ†å¯èƒ½å¼•å…¥è¡Œä¸ºå˜åŒ– | ä¸­ | ä¿æŒç°æœ‰æµ‹è¯•é€šè¿‡ï¼Œå¿…è¦æ—¶æ·»åŠ æ–°æµ‹è¯• |
| æ–‡ä»¶é‡æ„å¯èƒ½å½±å“ git å†å² | ä½ | ä½¿ç”¨ git mv ä¿ç•™å†å²è®°å½• |
| å¤šçº¿ç¨‹é”ä¿®æ”¹å¯èƒ½å¼•å…¥æ­»é” | é«˜ | ä»”ç»†å®¡æŸ¥é”è·å–é¡ºåºï¼Œæ·»åŠ æ­»é”æµ‹è¯• |

---

## âœ… éªŒè¯æ–¹æ¡ˆ

1. **å•å…ƒæµ‹è¯•**ï¼šç¡®ä¿æ‰€æœ‰ 85+ æµ‹è¯•é€šè¿‡
2. **é›†æˆæµ‹è¯•**ï¼šæ‰‹åŠ¨æµ‹è¯•æ’­æ”¾ã€æ‰«æã€æ­Œè¯æ˜¾ç¤ºç­‰æ ¸å¿ƒåŠŸèƒ½
3. **é™æ€æ£€æŸ¥**ï¼š`cargo clippy` æ— è­¦å‘Š
4. **æ€§èƒ½æµ‹è¯•**ï¼šç¡®ä¿éŸ³é¢‘æ’­æ”¾æ— å¡é¡¿

---

è¯·ç¡®è®¤è®¡åˆ’åï¼Œæˆ‘å°†å¼€å§‹æ‰§è¡Œå…·ä½“çš„ä»£ç ä¼˜åŒ–å·¥ä½œã€‚